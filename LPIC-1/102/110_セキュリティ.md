# 11-1 ホストレベルのセキュリティ
  
## セキュリティを高めるために...
- 以下の設定を行う
  - 外部からの侵入に対するセキュリティを強化する
    - 不要なサービスやソフトウェアをインストールしない
    - 適切なアクセス制御を行う
    - パケットフィルタリングを行う
    - セキュリティ情報の確認を行い、必要があれば対策を実施する
  - 内部からの侵入に対するセキュリティを強化する
    - 適切なユーザ管理を行う
    - スーパーユーザー権限で動作するプログラムを最小限にする

## デーモン
- 常駐型のプログラム
  - 常時起動した状態になっている
  - クライアントからの要求を待っている
- 起動中にデーモンが多いと...
  - メモリなどのリソースを圧迫する
  - セキュリティホールになる可能性がある
```
[root@centos7 ~]# ps -e
  PID TTY          TIME CMD
    1 ?        00:00:00 systemd
    2 ?        00:00:00 kthreadd
    3 ?        00:00:00 ksoftirqd/0
    5 ?        00:00:00 kworker/0:0H
    7 ?        00:00:00 migration/0
    8 ?        00:00:00 rcu_bh
    9 ?        00:00:00 rcu_sched
   10 ?        00:00:00 lru-add-drain
   11 ?        00:00:00 watchdog/0
   13 ?        00:00:00 kdevtmpfs
   14 ?        00:00:00 netns
   15 ?        00:00:00 khungtaskd
   16 ?        00:00:00 writeback
   17 ?        00:00:00 kintegrityd
   18 ?        00:00:00 bioset
   19 ?        00:00:00 bioset
   20 ?        00:00:00 bioset
   21 ?        00:00:00 kblockd
   22 ?        00:00:00 md
   (以下省略)
```

## スーパーサーバ
- デーモン(サーバプログラム)に代わって、クライアントからの要求を受け取る
  - デーモンは、要求に応じて起動する
  - inetdと、xinetdがある

## スーパーサーバの特徴
- スーパーサーバのメリット
  - リソースを効率よく使うことができる
  - TCP Wrapperと組み合わせて、アクセス制御をかけることができる
- スーパーサーバのデメリット
  - クライアントへの応答が遅くなる
    - クライアントへすぐに応答する必要があるデーモンは、スーパーサーバを経由しない(スタンドアロン)ほうがいい

## inetdの設定
- `/etc/inetd.conf`で行う
  ```
  [root@centos7 ~]# cat /etc/inetd.conf
  telnet stream tcp nowait root /usr/libexec/telnetd telnetd
  ```
  - telnet
    - `/etc/service`で定義されているサービス名
  - stream
    - ソケットタイプ
      - stream: TCP
      - dgram: UDP
  - tcp
    - プロトコル
  - nowait
    - サービスの要求の処理方法
      - wait: 処理が終了するまで、次の要求を待機
      - nowait: 待機せずに次の処理を実行
  - /usr/libexec/telnetd
    - プログラムのフルパス。TCP Wrapperを経由する場合は、tcpd
  - telnetd
    - 引数
- 変更後、inetdを再起動する
  ```
  [root@centos7 ~]# /etc/init.d/initd restart
  ```
  ```
  [root@centos7 ~]# killall -HUP inetd
  ```
  ```
  [root@centos7 ~]# kill -HUP inetdのPID
  ```
  - 最近のディストリビューションでは、inetdを使わず、`xinetd`を使うものが大半である

## TCP Wrapper
- `/etc/hosts.allow`、`/etc/hosts.deny`ファイルに基づいて、アクセス制御を行う
  - 実態は、tcpdデーモン
  - libwrapを使用しているアプリケーションは、tcpdなしでTCP Wrapperの機能を利用する

## TCP Wrapperのアクセス制御
- 以下のルールに従って行う
  - `/etc/hosts.allow`をチェックする
    - ここで許可されているホストは、許可
  - `/etc/hosts.deny`をチェックする
    - ここで拒否されているホストは、拒否
    - ここで拒否されていないホストは、許可
- 記入例(どちらのファイルも書式は同じ)
  - ai-plus.comからのTelnetと、192.168.28.0/24からの全アクセスを許可(拒否)する
    ```
    in.telnetd: .ai-plus.com
    ALL: 192.168.28.
    ```

## /etc/hosts.allowと/etc/hosts.deny
- どちらのファイルも書式は同じ
  - サービス名: 対象のホスト
    | オプション | 説明 |
    | ---- | ---- |
    | ALL | 全てのサービスまたはホスト |
    | A EXCEPT B | B以外のA |
    | LOCAL | .を含まないホスト(ローカルネットワークセグメント内のホスト) |
    | PARANOID | ホスト名からDNSで検索したアドレスと、サービス要求元アドレスが一致しない |
  - 全アクセスを許可(拒否)する
    ```
    ALl: ALL
    ```

## TCP Wrapperのログ
- 認証関連のログは、`/var/log/secure`に記録されている
  ```
  [root@centos7 ~]# cat /var/log/secure
  Oct 30 05:51:04 centos7 polkitd[1470]: Registered Authentication Agent for unix-process:2243:2051411 (system bus name :1.33 [/usr/bin/pkttyagent --notify-fd 5 --fallback], object path /org/freedesktop/PolicyKit1/AuthenticationAgent, locale C)
  Oct 30 22:07:29 centos7 polkitd[1459]: Loading rules from directory /etc/polkit-1/rules.d
  Oct 30 22:07:29 centos7 polkitd[1459]: Loading rules from directory /usr/share/polkit-1/rules.d
  Oct 30 22:07:29 centos7 polkitd[1459]: Finished loading, compiling and executing 2 rules
  Oct 30 22:07:29 centos7 polkitd[1459]: Acquired the name org.freedesktop.PolicyKit1 on the system bus
  Oct 30 22:07:30 centos7 sshd[1734]: Server listening on 0.0.0.0 port 22.
  Oct 30 22:07:30 centos7 sshd[1734]: Server listening on :: port 22.
  (以下省略)
  ```

## xinitdの設定
- 設定ファイルが2種類ある
  - 全体的な設定を、`/etc/xinitd.conf`で行う
    ```
    [root@centos7 ~]# cat /etc/xinetd.conf
    #
    # This is the master xinetd configuration file. Settings in the
    # default section will be inherited by all service configurations
    # unless explicitly overridden in the service configuration. See
    # xinetd.conf in the man pages for a more detailed explanation of
    # these attributes.

    defaults
    {
    # The next two items are intended to be a quick access place to
    # temporarily enable or disable services.
    #
    #       enabled         =
    #       disabled        =

    # Define general logging characteristics.
            log_type        = SYSLOG daemon info
            log_on_failure  = HOST
            log_on_success  = PID HOST DURATION EXIT

    # Define access restriction defaults
    #
    #       no_access       =
    #       only_from       =
    #       max_load        = 0
            cps             = 50 10
            instances       = 50
            per_source      = 10

    # Address and networking defaults
    #
    #       bind            =
    #       mdns            = yes
            v6only          = no

    # setup environmental attributes
    #
    #       passenv         =
            groups          = yes
            umask           = 002

    # Generally, banners are not used. This sets up their global defaults
    #
    #       banner          =
    #       banner_fail     =
    #       banner_success  =
    }

    includedir /etc/xinetd.d
    ```
  - サービスごとの設定は、別途設定ファイルに記述して、`/etc/xinetd.d`ディレクトリに格納する

- サービスごとの設定
  - 適当なファイル名(通常、サービス名と同じ)で、サービスごとの設定を作る
    ```
    [root@centos7 ~]# cat /etc/xinetd.d/rsync
    service rsync
    {
        disable = no
        socket_type = stream
        wait = no
        user = root
        server = /usr/bin/rsync
        server_args = --daemon
        log_on_failure += USERID
    }
    ```

    | パラメータ | 説明 |
    | ---- | ---- |
    | disable | サービスの有効/無効 |
    | socket_type | 通信のタイプ(TCPはstream、UDPはdgram) |
    | wait | ウェイトタイム |
    | user | サービスを実行するユーザ名 |
    | server | サーバプログラム(デーモン)へのフルパス |
    | server_args | サーバプログラム(デーモン)へ渡す引数 |
    | log_on_falure | 接続を拒否したときに、ログに記録する内容 |
    | nice | 実行優先度 |
    | only_from | 接続を許可する接続元 |
    | no_access | 接続を拒否する接続元 |
    | access_times | アクセスを許可する時間帯 |

  - 設定ファイルを、`/etc/xinet.d`ディレクトリに置く
    ```
    [root@centos7 ~]# ls /etc/xinetd.d
    chargen-dgram   daytime-dgram   discard-dgram   echo-dgram   rsync          time-dgram
    chargen-stream  daytime-stream  discard-stream  echo-stream  tcpmux-server  time-stream
    ```
  - xinetdを再起動する
    ```
    [root@centos7 ~]# /etc/init.d/xinetd restart
    ```

## 開いているポートの確認
- netstatコマンドかlsofコマンドで確認できる
  ```
  [root@centos7 ~]# netstat -atun
  Active Internet connections (servers and established)
  Proto Recv-Q Send-Q Local Address           Foreign Address         State
  tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN
  tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN
  tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN
  tcp        0      0 10.0.2.15:37778         137.132.155.197:80      TIME_WAIT
  tcp        0      0 10.0.2.15:37780         137.132.155.197:80      TIME_WAIT
  tcp        0      0 10.0.2.15:37776         137.132.155.197:80      TIME_WAIT
  tcp        0      0 10.0.2.15:22            10.0.2.2:59015          ESTABLISHED
  tcp6       0      0 :::22                   :::*                    LISTEN
  tcp6       0      0 ::1:631                 :::*                    LISTEN
  udp        0      0 0.0.0.0:68              0.0.0.0:*
  udp        0      0 127.0.0.1:323           0.0.0.0:*
  udp6       0      0 ::1:323                 :::*
  ```

## lsofコマンド
- ファイルやポート番号を開いているプロセスを表示する
- lsofコマンドの書式
  - lsof [オプション]
    | オプション | 説明 |
    | ---- | ---- |
    | -c コマンド | 指定したコマンドに一致するプロセスだけを表示する |
    | -i [:ポート] | 指定したポート番号のIP通信だけを表示する |
    | -p PID | 指定したPIDのプロセスだけを表示する |
    | -u UID | 指定したユーザID(またはユーザ名)のプロセスだけを表示する |
  - 開いているポート番号を表示する
    ```
    [root@centos7 ~]# lsof -i
    COMMAND   PID    USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
    chronyd  1468  chrony    1u  IPv4  17754      0t0  UDP localhost:323
    chronyd  1468  chrony    2u  IPv6  17755      0t0  UDP localhost:323
    sshd     1734    root    3u  IPv4  20749      0t0  TCP *:ssh (LISTEN)
    sshd     1734    root    4u  IPv6  20758      0t0  TCP *:ssh (LISTEN)
    cupsd    1738    root   10u  IPv6  20766      0t0  TCP localhost:ipp (LISTEN)
    cupsd    1738    root   11u  IPv4  20767      0t0  TCP localhost:ipp (LISTEN)
    sshd     1919    root    3u  IPv4  21006      0t0  TCP centos7:ssh->gateway:59015 (ESTABLISHED)
    sshd     1921 penguin    3u  IPv4  21006      0t0  TCP centos7:ssh->gateway:59015 (ESTABLISHED)
    dhclient 2377    root    6u  IPv4  23419      0t0  UDP *:bootpc
    sendmail 2451    root    4u  IPv4  23896      0t0  TCP localhost:smtp (LISTEN)
    ```

## nmapコマンド
- 指定したホストに対してポートスキャンを行う
  - 開いているポートをリモートで確認する
  - クラッカーが攻撃前の調査として行う
    - インターネット上の他のコンピュータに対して行わないこと
- nmapコマンドの書式
  - nmapホスト
  - www.sample.localへのポートスキャンを行う
    ```
    [root@centos7 ~]# nmap www.sample.local
    ```

## SUIDが設定されているファイル
- SUIDが設定されているプログラム実行時に限り、ファイル所有者の権限でファイルを開く
  - 一般ユーザが実行しても、スーパーユーザの権限でファイルを開くことができてしまう可能性あり
    - SUIDが設定されているファイルを検索する
      ```
      [root@centos7 ~]# find / -perm -u+s -ls
      ```
    - SGIDが設定されているファイルを検索する
      ```
      [root@centos7 ~]# find / -perm -g+s -ls
      ```

# 11-2 ユーザに対するセキュリティ管理

## ユーザに対するセキュリティ
- 